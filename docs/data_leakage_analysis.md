# データリーク分析レポート

## 問題の概要

Phase2の特徴量抽出段階で、**StandardScalerが全データ（訓練+テスト）でfitされている**ため、データリークが発生しています。

## データリークの発生箇所

### 1. `extract_features_from_wikiart_vlm()` (line 626)

```python
# 特徴量をスケーリング
features_scaled = self.scaler.fit_transform(features_df[feature_columns])
```

**問題点**:
- 全データ（訓練+テスト）で`fit_transform()`を実行
- テストデータの統計情報（平均、標準偏差）が訓練データに漏れている
- これにより、モデルの性能が過大評価される可能性がある

### 2. `extract_features_with_gestalt_scores()` (line 820)

```python
# 新しいスケーラーでスケーリング
merged_scaler = StandardScaler()
merged_scaled = merged_scaler.fit_transform(merged_df[feature_columns])
```

**問題点**:
- 全データ（訓練+テスト）で`fit_transform()`を実行
- ゲシュタルトスコア統合後も同様の問題が発生

### 3. `random_forest_trainer.py` (line 184-187)

```python
# データを読み込み
df = self.load_features()  # スケーリング済みデータを読み込み

# データを準備
X, y, feature_names = self.prepare_data(df)  # スケーリング済みデータを使用

# 訓練・テスト分割
train_indices, test_indices = train_test_split(...)
```

**問題点**:
- スケーリング済みデータを読み込んで、そのまま分割
- スケーリングは既に全データで行われているため、データリークが発生

## データリークの影響

1. **過大評価**: モデルの性能（精度、F1スコア）が実際よりも高く評価される
2. **汎化性能の誤解**: テストデータの情報が訓練データに漏れているため、実際の汎化性能が不明
3. **再現性の問題**: 本番環境での性能が期待値と大きく異なる可能性

## 修正方法

### 方法1: 特徴量抽出時にスケーリングをスキップ（推奨）

**変更内容**:
1. 特徴量抽出段階ではスケーリングを行わない（生の特徴量を保存）
2. データ分割後に、訓練データのみでStandardScalerをfit
3. 訓練データでfitしたStandardScalerでテストデータをtransform

**メリット**:
- データリークを完全に防止
- 標準的な機械学習のベストプラクティスに準拠
- 後方互換性の問題なし（新しいファイル名を使用）

**デメリット**:
- 既存のスケーリング済みファイルとの互換性が失われる
- モデル訓練時にスケーリング処理を追加する必要がある

### 方法2: 生の特徴量とスケーリング済み特徴量の両方を保存

**変更内容**:
1. 生の特徴量を`wikiart_vlm_features_{generation_model}_raw.csv`として保存
2. スケーリング済み特徴量を`wikiart_vlm_features_{generation_model}.csv`として保存（既存）
3. モデル訓練時に、生の特徴量を読み込んで、データ分割後にスケーリング

**メリット**:
- 既存のスケーリング済みファイルとの互換性を維持
- データリークを防止
- 柔軟性が高い

**デメリット**:
- ファイル数が増加
- ストレージ使用量が増加

## 推奨される修正方法

**方法1を推奨**します。理由：
1. データリークを完全に防止
2. 標準的な機械学習のベストプラクティスに準拠
3. 実装がシンプル

## 修正の実装

### 1. `extract_features_from_wikiart_vlm()`の修正

- スケーリング処理を削除またはオプション化
- 生の特徴量を保存

### 2. `extract_features_with_gestalt_scores()`の修正

- スケーリング処理を削除またはオプション化
- 生の特徴量を保存

### 3. `random_forest_trainer.py`の修正

- 生の特徴量を読み込み
- データ分割後に、訓練データのみでStandardScalerをfit
- 訓練データでfitしたStandardScalerでテストデータをtransform

## 注意事項

1. **既存ファイルとの互換性**: 既存のスケーリング済みファイルを使用している場合は、新しいファイル名を使用する必要がある
2. **後方互換性**: 既存のコードがスケーリング済みデータを期待している場合は、段階的な移行が必要
3. **検証**: 修正後、モデルの性能が適切に評価されることを確認する必要がある

